<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiniChat</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans SC", "PingFang SC", "Microsoft Yahei", sans-serif;
      background: #f5f7fa;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .wrap {
      width: min(1000px, 92vw);
      height: 92vh;
      max-height: 720px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
      background: #fff;
      border: 1px solid #dcdfe6;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      overflow: hidden;
      position: relative;
    }
    header { display: flex; align-items: center; justify-content: space-between; }
    header .title { font-weight: 700; font-size: 20px; color: #2563eb; }
    header .me { font-size: 14px; color: #666; }

    .main {
      display: grid; grid-template-columns: 1fr 240px; gap: 12px;
      min-height: 0;
    }
    .chat, aside {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fafafa;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
      min-height: 0;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    .msg {
      padding: 8px 10px;
      border-radius: 10px;
      background: #eef2f7;
      line-height: 1.5;
      max-width: 80%;
      word-break: break-word;
    }
    .mine { align-self: flex-end; background: #d9f2e5; }
    .system { align-self: center; background: transparent; color: #888; font-size: 13px; }
    .msg img {
      max-width: 360px;
      max-height: 260px;
      border-radius: 8px;
      display: block;
    }
    aside h3 { margin: 0 0 6px 0; font-size: 14px; color: #333; }
    .users { font-size: 14px; display: flex; flex-direction: column; gap: 4px; }

    .input {
      display: grid;
      grid-template-columns: auto auto 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .input input[type="text"] {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 15px;
      outline: none;
      background: #fff;
      color: #333;
    }
    .input button {
      background: #2563eb;
      border: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      min-height: 40px;
      touch-action: manipulation;
    }
    .input button:disabled { opacity: 0.6; cursor: not-allowed; }
    .muted { color: #777; font-size: 12px; }
    .ts { color: #999; font-size: 11px; margin-left: 6px; }
    .drop {
      border: 2px dashed #bcd0ff;
      border-radius: 10px;
      padding: 6px;
      text-align: center;
      color: #557;
      font-size: 12px;
      background: #fff;
      flex: 0 0 auto;
    }

    /* Emoji/Sticker panel */
    .emoji-panel {
      position: absolute;
      z-index: 20;
      top: 72px;
      left: 16px;
      right: 16px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      padding: 10px;
      display: none;
    }
    .emoji-panel .tabs { display: flex; gap: 8px; margin-bottom: 8px; }
    .emoji-panel .tab {
      background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px;
      padding: 6px 10px; cursor: pointer; font-weight: 600; color: #333;
    }
    .emoji-panel .tab.active { background: #2563eb; color: #fff; border-color: #2563eb; }
    .emoji-panel .content { max-height: 220px; overflow: auto; }
    .emoji-panel .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 6px; }
    .emoji-panel .grid img { width: 56px; height: 56px; object-fit: contain; cursor: pointer; }
    .emoji-item {
      display: flex; align-items: center; justify-content: center;
      height: 36px; border-radius: 8px; background: #f9fafb; border: 1px solid #e5e7eb;
      font-size: 20px; cursor: pointer;
    }
    .emoji-panel .grid:not(.active) { display: none; }

    /* nickname first-visit modal */
    .modal-mask {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      display: none; align-items: center; justify-content: center; z-index: 100;
    }
    .modal {
      width: min(480px, 92vw);
      background: #fff; border-radius: 12px; box-shadow: 0 12px 32px rgba(0,0,0,.2);
      padding: 18px; display: grid; gap: 12px;
      border: 1px solid #e5e7eb;
    }
    .modal h3 { margin: 0; font-size: 18px; color: #111; }
    .modal .row { display: grid; gap: 8px; }
    .modal input[type="text"] {
      border: 1px solid #cbd5e1; border-radius: 10px; padding: 10px 12px; font-size: 15px;
    }
    .modal .actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn { background: #2563eb; border: none; color: #fff; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: #f3f4f6; color: #333; border: 1px solid #e5e7eb; }

    /* å¼¹çª—æ˜¾ç¤ºæ—¶éšè—åº•éƒ¨æ˜µç§°/åŠ å…¥ï¼ˆåŒä¿é™©ï¼‰ */
    #nameMask[style*="display: flex"] ~ .main + .input #name,
    #nameMask[style*="display: flex"] ~ .main + .input #join {
      display: none !important;
    }

    /* Mobile-friendly */
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    @supports (height: 100dvh) {
      body { height: 100dvh; }
      .wrap { height: 100dvh; max-height: none; }
    }

    @media (max-width: 640px) {
      body { height: 100dvh; }
      .wrap {
        width: 100vw;
        height: 100dvh;
        max-height: none;
        border-radius: 0;
        padding: 8px;
      }
      .main { grid-template-columns: 1fr; }
      aside { order: 3; max-height: 30vh; overflow: auto; }
      .chat { order: 1; }
      .input {
        order: 2;
        position: sticky;
        bottom: 0;
        background: #fff;
        padding-top: 8px;
        padding-bottom: calc(8px + var(--safe-bottom));
        display: grid;
        grid-template-columns: auto auto 1fr auto; /* emoji, file, msg, send */
        gap: 8px;
      }
      .emoji-panel {
        position: fixed;
        left: 8px; right: 8px;
        bottom: calc(60px + var(--safe-bottom));
        top: auto;
        max-height: 40vh;
      }
      .drop { font-size: 11px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">MiniChat</div>
      <div class="me">ä½ çš„æ˜µç§°ï¼š<span id="meName">æœªè®¾ç½®</span></div>
    </header>

    <!-- Nickname modal -->
    <div id="nameMask" class="modal-mask">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="nameTitle">
        <h3 id="nameTitle">è®¾ç½®ä½ çš„æ˜µç§°</h3>
        <div class="row">
          <label for="firstName">æ˜µç§°</label>
          <input id="firstName" type="text" placeholder="ä¾‹å¦‚ï¼šå°æ˜ / Alice" />
        </div>
        <div class="actions">
          <button id="nameCancel" class="btn secondary">ç¨å</button>
          <button id="nameOk" class="btn">è¿›å…¥èŠå¤©å®¤</button>
        </div>
      </div>
    </div>

    <div class="main">
      <section class="chat">
        <div class="drop">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–åœ¨è¾“å…¥æ¡†å†…ç²˜è´´å›¾ç‰‡ï¼Œå³å¯å‘é€ï¼ˆâ‰¤5MBï¼‰</div>
        <div id="messages" class="messages"></div>
      </section>
      <aside>
        <h3>åœ¨çº¿ç”¨æˆ·</h3>
        <div class="users" id="users"></div>
        <div class="muted">Tipsï¼šæ¢ä¸ªæµè§ˆå™¨/æ— ç—•çª—å£å¯æ¨¡æ‹Ÿå¤šäººã€‚</div>
      </aside>
    </div>

    <div class="input">
      <button id="emojiBtn" title="è¡¨æƒ…">ğŸ˜€</button>
      <button id="pickBtn" title="å‘é€æ–‡ä»¶">æ–‡ä»¶</button>
      <input id="name" type="text" placeholder="è¾“å…¥ä½ çš„æ˜µç§°â€¦" />
      <button id="join">åŠ å…¥</button>
      <input id="msg" type="text" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€â€¦" disabled />
      <button id="send" disabled>å‘é€</button>
      <input id="pick" type="file" style="display:none" />
    </div>
  </div>

  <script>
    (function() {
      var el = function(s) { return document.querySelector(s); };
      var messages = el('#messages');
      var users = el('#users');
      var meName = el('#meName');
      var joinBtn = el('#join');
      var sendBtn = el('#send');
      var nameInput = el('#name');
      var msgInput = el('#msg');
      var picker = el('#pick');
      var pickBtn = el('#pickBtn');
      var emojiBtn = el('#emojiBtn');
      var dropZone = document.querySelector('.drop');
      var ws = null, me = null;

      /* Emoji/è´´çº¸é¢æ¿ï¼ˆå« 4 å¼ å†…ç½® SVG è´´çº¸ï¼‰ */
      var emojiPanel = (function ensureEmojiPanel(){
        var panel = document.getElementById('emojiPanel');
        if (!panel) {
          panel = document.createElement('div');
          panel.id = 'emojiPanel';
          panel.className = 'emoji-panel';
          panel.innerHTML =
            '<div class="tabs">' +
              '<button data-tab="emojis" class="tab active">è¡¨æƒ…</button>' +
              '<button data-tab="stickers" class="tab">è´´çº¸</button>' +
            '</div>' +
            '<div class="content">' +
              '<div class="emojis grid active" id="emojiGrid"></div>' +
              '<div class="stickers grid" id="stickerGrid">' +
                '<img src="/static/stickers/smile.svg" alt="smile" data-name="smile.svg"/>' +
                '<img src="/static/stickers/heart.svg" alt="heart" data-name="heart.svg"/>' +
                '<img src="/static/stickers/thumbs.svg" alt="thumbs" data-name="thumbs.svg"/>' +
                '<img src="/static/stickers/party.svg" alt="party" data-name="party.svg"/>' +
              '</div>' +
            '</div>';
          document.querySelector('.wrap').appendChild(panel);
        }
        return panel;
      })();
      var emojiGrid = document.getElementById('emojiGrid');
      var stickerGrid = document.getElementById('stickerGrid');

      function wsUrl(username) {
        var loc = window.location;
        var proto = (loc.protocol === 'https:') ? 'wss' : 'ws';
        return proto + '://' + loc.host + '/ws?username=' + encodeURIComponent(username);
      }

      function scrollToBottom() { messages.scrollTop = messages.scrollHeight; }

      var MAX_VISIBLE = 20;
      function trimToMax() {
        while (messages.children.length > MAX_VISIBLE) {
          messages.removeChild(messages.firstChild);
        }
      }

      function addMessage(obj, mine) {
        var type = obj.type, user = obj.user, data = obj.data, name = obj.name, ts = obj.ts;
        var div = document.createElement('div');
        div.className = 'msg ' + (type === 'system' ? 'system' : (mine ? 'mine' : ''));
        if (type === 'system') {
          div.textContent = data;
        } else if (type === 'image') {
          var who = document.createElement('div');
          who.innerHTML = '<strong>' + (user || 'ç³»ç»Ÿ') + ':</strong> <span class="ts">' + (ts || '') + '</span>';
          var img = document.createElement('img');
          img.src = data;
          img.alt = name || 'å›¾ç‰‡';
          img.loading = 'lazy';
          img.style.cursor = 'pointer';
          img.onclick = function() { window.open(data, '_blank'); };
          img.onload = function() { scrollToBottom(); };
          div.appendChild(who);
          div.appendChild(img);
          if (name) {
            var cap = document.createElement('div');
            cap.className = 'ts';
            cap.textContent = name;
            div.appendChild(cap);
          }
        } else if (type === 'file') {
          var whof = document.createElement('div');
          whof.innerHTML = '<strong>' + (user || 'ç³»ç»Ÿ') + ':</strong> <span class="ts">' + (ts || '') + '</span>';
          var link = document.createElement('a');
          link.href = data;
          link.textContent = name || 'ä¸‹è½½æ–‡ä»¶';
          link.target = "_blank";
          link.style.color = "#2563eb";
          link.rel = "noopener";
          div.appendChild(whof);
          div.appendChild(link);
        } else {
          var who2 = document.createElement('strong');
          who2.textContent = (user || 'ç³»ç»Ÿ') + ': ';
          var text = document.createElement('span');
          text.textContent = data;
          div.appendChild(who2);
          div.appendChild(text);
          if (ts) {
            var t = document.createElement('span');
            t.className = 'ts';
            t.textContent = ts;
            div.appendChild(t);
          }
        }
        messages.appendChild(div);
        trimToMax();
        scrollToBottom();
      }

      function setUsers(list) {
        users.innerHTML = '';
        for (var i = 0; i < list.length; i++) {
          var item = document.createElement('div');
          item.textContent = 'â€¢ ' + list[i];
          users.appendChild(item);
        }
      }

      // ä¸Šä¼ ï¼ˆä»»æ„æ–‡ä»¶ï¼›å›¾ç‰‡ä½œä¸ºå›¾ç‰‡æ¶ˆæ¯ï¼Œå…¶ä»–ä½œä¸ºæ–‡ä»¶æ¶ˆæ¯ï¼‰+ 60s è¶…æ—¶
      function uploadAndSend(file) {
        if (!file) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          alert('è¯·å…ˆåŠ å…¥èŠå¤©å®¤');
          return;
        }
        var form = new FormData();
        form.append('file', file);

        var controller = new AbortController();
        var timer = setTimeout(function(){ controller.abort(); }, 60000);

        fetch('/upload', { method: 'POST', body: form, signal: controller.signal })
          .then(function(res) {
            if (!res.ok) return res.json().then(function(e){ throw new Error(e.detail || 'ä¸Šä¼ å¤±è´¥'); });
            return res.json();
          })
          .then(function(info) {
            if (file.type && file.type.startsWith('image/')) {
              ws.send(JSON.stringify({ type: 'image', data: info.url, name: info.name }));
            } else {
              ws.send(JSON.stringify({ type: 'file', data: info.url, name: info.name }));
            }
            scrollToBottom();
            picker.value = '';
          })
          .catch(function(e) {
            var msg = (e.name === 'AbortError') ? 'æ–‡ä»¶ä¸Šä¼ è¶…æ—¶ï¼ˆ60sï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ/æ‰©å±•' : ('æ–‡ä»¶å‘é€å¤±è´¥ï¼š' + e.message);
            addMessage({ type: 'system', data: msg });
            picker.value = '';
          })
          .finally(function(){ clearTimeout(timer); });
      }

      function connect() {
        var username = nameInput.value.trim() || ('è®¿å®¢' + Math.floor(Math.random()*1000));
        me = username;
        meName.textContent = me;
        ws = new WebSocket(wsUrl(username));
        ws.onopen = function() {
          msgInput.disabled = false;
          sendBtn.disabled = false;
          nameInput.disabled = true;
          joinBtn.disabled = true;
          // åŠ å…¥åéšè—åº•éƒ¨æ˜µç§°/åŠ å…¥
          try { nameInput.style.display = 'none'; } catch(e) {}
          try { joinBtn.style.display = 'none'; } catch(e) {}
          msgInput.focus();
        };
        ws.onmessage = function(ev) {
          var msg = {};
          try { msg = JSON.parse(ev.data); } catch (e) { return; }
          if (msg.type === 'participants') setUsers(msg.data || []);
          else if (msg.type === 'history') {
            var arr = msg.data || [];
            for (var i = 0; i < arr.length; i++) addMessage(arr[i], arr[i].user === me);
          } else if (msg.type === 'chat' || msg.type === 'system' || msg.type === 'image' || msg.type === 'file') {
            addMessage(msg, msg.user === me);
          }
        };
        ws.onclose = function() {
          addMessage({ type: 'system', data: 'è¿æ¥å·²å…³é—­ï¼Œè¯·é‡æ–°åŠ å…¥ã€‚' });
          msgInput.disabled = true;
          sendBtn.disabled = true;
          nameInput.disabled = false;
          joinBtn.disabled = false;
          try { nameInput.style.display = ''; } catch(e) {}
          try { joinBtn.style.display = ''; } catch(e) {}
        };
      }

      // Emoji & Stickers
      var EMOJIS = ["ğŸ˜€","ğŸ˜","ğŸ˜‚","ğŸ¤£","ğŸ˜Š","ğŸ˜","ğŸ˜˜","ğŸ˜","ğŸ¤”","ğŸ‘","ğŸ‘","ğŸ™Œ","ğŸ™","ğŸ’ª","ğŸ”¥","ğŸ‰","ğŸ¥³","ğŸŒŸ","ğŸ’¯","â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ¤","ğŸ¤","ğŸ–¤","âœ¨","ğŸ˜´"];
      var emojiGrid = document.getElementById('emojiGrid');
      var stickerGrid = document.getElementById('stickerGrid');

      function renderEmojis(){
        emojiGrid.innerHTML = "";
        for (var i=0;i<EMOJIS.length;i++){
          var item = document.createElement('div');
          item.className = 'emoji-item';
          item.textContent = EMOJIS[i];
          item.title = EMOJIS[i];
          item.addEventListener('click', function(e){
            insertAtCursor(msgInput, e.currentTarget.textContent);
            msgInput.focus();
          });
          emojiGrid.appendChild(item);
        }
      }
      function insertAtCursor(input, text){
        var start = input.selectionStart || 0;
        var end = input.selectionEnd || 0;
        var value = input.value;
        input.value = value.substring(0, start) + text + value.substring(end);
        var cursor = start + text.length;
        input.selectionStart = input.selectionEnd = cursor;
      }
      renderEmojis();

      function toggleEmojiPanel(){
        var visible = emojiPanel.style.display !== 'none';
        emojiPanel.style.display = visible ? 'none' : 'block';
      }
      document.getElementById('emojiBtn').addEventListener('click', function(){ toggleEmojiPanel(); });
      document.addEventListener('click', function(e){
        var target = e.target;
        if (!emojiPanel.contains(target) && target !== document.getElementById('emojiBtn')){
          emojiPanel.style.display = 'none';
        }
      });
      (function(){
        var tabs = emojiPanel.querySelectorAll('.tab');
        for (var i=0;i<tabs.length;i++){
          (function(tab){
            tab.addEventListener('click', function(){
              for (var j=0;j<tabs.length;j++){ tabs[j].classList.remove('active'); }
              tab.classList.add('active');
              if (tab.getAttribute('data-tab') === 'emojis'){
                emojiPanel.querySelector('.emojis').classList.add('active');
                emojiPanel.querySelector('.stickers').classList.remove('active');
              } else {
                emojiPanel.querySelector('.emojis').classList.remove('active');
                emojiPanel.querySelector('.stickers').classList.add('active');
              }
            });
          })(tabs[i]);
        }
      })();
      if (stickerGrid) {
        stickerGrid.addEventListener('click', function(e){
          var img = e.target.closest('img');
          if (!img) return;
          if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('è¯·å…ˆåŠ å…¥èŠå¤©å®¤');
            return;
          }
          var url = img.getAttribute('src');
          var name = img.getAttribute('data-name') || 'sticker';
          ws.send(JSON.stringify({ type: 'image', data: url, name: name }));
        });
      }

      // é¦–æ¬¡è®¿é—®å¼¹çª— & è‡ªåŠ¨åŠ å…¥
      var nameMask = document.getElementById('nameMask');
      var firstName = document.getElementById('firstName');
      var nameOk = document.getElementById('nameOk');
      var nameCancel = document.getElementById('nameCancel');

      function showNameModal() {
        nameMask.style.display = 'flex';
        // æ˜¾ç¤ºå¼¹çª—æ—¶ç«‹å³éšè—åº•éƒ¨æ˜µç§°/åŠ å…¥ï¼ˆåŒä¿é™©ï¼‰
        try { nameInput.style.display = 'none'; } catch(e) {}
        try { joinBtn.style.display = 'none'; } catch(e) {}
        setTimeout(function(){ firstName.focus(); }, 50);
      }
      function hideNameModal() {
        nameMask.style.display = 'none';
        // åŠ å…¥åè¿™ä¸¤ä¸ªæ§ä»¶ä¿æŒéšè—
        try { nameInput.style.display = 'none'; } catch(e) {}
        try { joinBtn.style.display = 'none'; } catch(e) {}
      }
      function doJoinWith(name) {
        nameInput.value = name;
        meName.textContent = name;
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          connect();
        }
      }
      (function initJoin() {
        try {
          var saved = localStorage.getItem('mc_name') || '';
          if (saved) { doJoinWith(saved); } else { showNameModal(); }
        } catch (e) { showNameModal(); }
      })();
      nameOk.addEventListener('click', function(){
        var v = (firstName.value || '').trim();
        if (!v) { firstName.focus(); return; }
        try { localStorage.setItem('mc_name', v); } catch (e) {}
        hideNameModal();
        doJoinWith(v);
      });
      nameCancel.addEventListener('click', function(){
        var gen = 'è®¿å®¢' + Math.floor(Math.random()*1000);
        try { localStorage.setItem('mc_name', gen); } catch (e) {}
        hideNameModal();
        doJoinWith(gen);
      });

      // æ‰“å¼€æ–‡ä»¶é€‰æ‹©
      pickBtn.addEventListener('click', function() { picker.click(); });
      picker.addEventListener('change', function() { if (picker.files && picker.files[0]) uploadAndSend(picker.files[0]); });

      // æ‰‹åŠ¨åŠ å…¥ï¼ˆPC å¯è§æ—¶ï¼‰
      joinBtn.addEventListener('click', connect);
      nameInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') connect(); });

      // å‘é€æ–‡æœ¬
      sendBtn.addEventListener('click', function() {
        var text = msgInput.value.trim();
        if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
        ws.send(JSON.stringify({ type: 'chat', data: text }));
        msgInput.value = '';
        msgInput.focus();
      });
      msgInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') sendBtn.click(); });

      // æ‹–æ‹½ä¸Šä¼ ï¼ˆä»»æ„æ–‡ä»¶ï¼‰
      ['dragenter','dragover','dragleave','drop'].forEach(function(evt) {
        dropZone.addEventListener(evt, function(e) { e.preventDefault(); e.stopPropagation(); });
      });
      dropZone.addEventListener('dragenter', function() { dropZone.style.background = '#eef5ff'; });
      dropZone.addEventListener('dragover',  function() { dropZone.style.background = '#eef5ff'; });
      dropZone.addEventListener('dragleave', function() { dropZone.style.background = ''; });
      dropZone.addEventListener('drop', function(e) {
        dropZone.style.background = '';
        var file = e.dataTransfer.files && e.dataTransfer.files[0];
        if (file) uploadAndSend(file);
      });

      // ç²˜è´´ä¸Šä¼ ï¼ˆé€šå¸¸ä»…å¯¹å›¾ç‰‡ç”Ÿæ•ˆï¼‰
      document.addEventListener('paste', function(e) {
        var items = (e.clipboardData && e.clipboardData.items) ? e.clipboardData.items : [];
        for (var i = 0; i < items.length; i++) {
          var it = items[i];
          if (it.type && it.type.indexOf('image/') === 0) {
            var file = it.getAsFile();
            if (file) uploadAndSend(file);
            break;
          }
        }
      });

      // iOS è½¯é”®ç›˜ï¼šè¾“å…¥æ¡†èšç„¦æ—¶æ»šåŠ¨åˆ°è§†å£ä¸­é—´
      msgInput.addEventListener('focus', function(){ setTimeout(function(){ msgInput.scrollIntoView({block:'center'}); }, 100); });
    })();
  </script>
</body>
</html>
